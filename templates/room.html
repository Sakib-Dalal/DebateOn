<!-- {% extends 'base.html' %} -->
<!-- {% block content %} -->

{% include "header.html" %}

<div id="room-container" class="container">
  <nav class="navbar navbar-expand-lg bg-body-light border-bottom">
    <div class="container-fluid">
        <a class="navbar-brand fs-2 fw-light mt-3" href="/">
                <h1 class="logo" style="font-size: 43px; position: relative; top: -50px;">
                    DebateOn
                </h1>
        </a>
        
        <div class="login" style="direction: ltr;">
          <div  id="navbarSupportedContent" >
            <ul class="navbar-nav me-auto mb-2 mb-lg-0" style="display: flex; flex-direction: row; margin-top: 20px;">
                
            </ul>               
          </div>
        </div>

      </div>
    </nav> 

  <!-- Room Code and Leave Button -->
  <div class="d-flex justify-content-between mb-3 mt-3" style="">
    <h2>Room Code: <span class="badge bg-secondary">{{room}}</span></h2>
    <a href="/" id="leave-chat-btn" class="btn btn-danger">Leave the Chat</a>
  </div>

  <!-- Chat Room Widget -->
  <div id="chat-room-widget" class="card">
    <div id="msgs-container" class="card-body" style="max-height: 700px;">
      <ul id="messages" class="list-unstyled"></ul>
    </div>

    <!-- Message Input and Send Button -->
    <div id="message-box" class="card-footer">
      <div class="input-group">
        <input type="text" placeholder="Enter your message" id="message-input" name="message" class="form-control" />
        <button type="button" id="send-btn" class="btn btn-primary" onclick="sendMessage()" style="background-color: #B692C2; color: white; border: #B692C2 solid;">Send</button>
      </div>
    </div>
  </div>

  <!-- JavaScript for Real-Time Messaging -->
  <script type="text/javascript">
    // Embed the user's name from the Flask template into JavaScript
    var currentUser = "{{ user }}";

    var socketio = io();

    // Function to display a chat message
    socketio.on("message", function (message) { 
      createChatItem(message.message, message.sender);
    });

    function createChatItem(message, sender) {
      var messages = document.getElementById("messages");
      var senderIsUser = currentUser === sender;
      var content = sender === "" ?
        `<h4 class="list-group-item list-group-item-info" style="display:none;">
            <strong>${currentUser}:</strong> ${message}
        </h4>` :
        `<h4 class="list-group-item ${senderIsUser ? "text-danger": "text-primary"}">
            <strong>${sender}:</strong> ${message}
        </h4>`;
      messages.innerHTML += content;
      // Auto-scroll to the latest message
      var msgsContainer = document.getElementById("msgs-container");
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }

    // Function to send a message
    function sendMessage() {
      var msgInput = document.getElementById("message-input");
      if (msgInput.value === "") return;
      var msg = msgInput.value;
      socketio.emit("message", { message: msg, sender: currentUser }); // Include sender info
      msgInput.value = "";
    }

    // Ensure the chat always scrolls to the bottom on page load
    window.onload = function() {
      var msgsContainer = document.getElementById("msgs-container");
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
  </script>

  <!-- Load existing messages -->
  {% for message in messages %}
  <script type="text/javascript">
    createChatItem("{{message.message}}", "{{message.sender}}");
  </script>
  {% endfor %}

<!-- {% endblock %} -->
{% include "footer.html" %}